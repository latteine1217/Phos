# Phos v0.2.0 Development Roadmap

**Planning Date**: 2025-12-19  
**Target Release**: TBD  
**Focus**: Batch Processing & Advanced Features

---

## 🎯 版本目標

v0.2.0 將專注於提升用戶體驗，增加批量處理能力和高級自定義功能，使 Phos 更適合專業攝影師和大量照片處理需求。

---

## ✨ 核心功能（Core Features）

### 1. 批量處理模式 🔥 (High Priority)

**目標**: 支援一次處理多張照片

**功能需求**:
- [ ] 多文件上傳界面（Streamlit `file_uploader` with `accept_multiple_files=True`）
- [ ] 批量處理引擎（循環處理每張照片）
- [ ] 並行處理優化（使用 `ProcessPoolExecutor` 提升速度）
- [ ] 錯誤處理機制（某張失敗不影響其他）

**技術方案**:
```python
def batch_process_images(
    uploaded_files: list,
    film_profile: FilmProfile,
    settings: dict
) -> list[np.ndarray]:
    """批量處理圖像"""
    results = []
    with ProcessPoolExecutor() as executor:
        futures = [
            executor.submit(process_single_image, file, film_profile, settings)
            for file in uploaded_files
        ]
        for future in futures:
            results.append(future.result())
    return results
```

**驗收標準**:
- 支援 2-50 張照片同時處理
- 處理速度提升 50%+ (vs 逐張處理)
- 記憶體占用可控（<2GB for 10 張照片）

---

### 2. 進度條顯示 📊 (Medium Priority)

**目標**: 提供清晰的處理進度反饋

**功能需求**:
- [ ] 批量處理總進度條（`st.progress`）
- [ ] 當前處理照片指示（"Processing 3/10..."）
- [ ] 各階段進度（預處理 → 胶片模擬 → 後處理）
- [ ] 處理時間預估（ETA）

**UI 設計**:
```
批量處理中...
━━━━━━━━━━━━━━━━━━━━ 30% (3/10)

當前: IMG_1234.jpg
階段: 胶片模擬 (Portra400)
預計剩餘時間: 45 秒
```

**驗收標準**:
- 進度條流暢更新（不卡頓）
- 時間預估誤差 <20%
- 支援取消操作

---

### 3. ZIP 批量下載 📦 (Medium Priority)

**目標**: 一鍵下載所有處理結果

**功能需求**:
- [ ] 生成 ZIP 壓縮檔（使用 `zipfile` 模塊）
- [ ] 檔名管理（保留原始檔名 + 胶片標記）
- [ ] 記憶體優化（流式壓縮，避免 OOM）
- [ ] 下載按鈕（`st.download_button`）

**檔名格式**:
```
原始檔名: IMG_1234.jpg
處理後: IMG_1234_Portra400.jpg

ZIP 檔名: Phos_Batch_Portra400_20251219_143052.zip
```

**驗收標準**:
- 支援下載 50+ 張照片
- 壓縮時間 <10 秒 (10 張照片)
- ZIP 檔案可正常解壓

---

## 🚀 進階功能（Advanced Features）

### 4. 高級參數調整 UI ⚙️ (Low Priority)

**目標**: 讓用戶微調胶片參數

**功能需求**:
- [ ] 參數調整面板（`st.sidebar` 或 `st.expander`）
- [ ] 實時預覽（調整參數後立即顯示效果）
- [ ] 參數範圍限制（避免極端值）
- [ ] 重置按鈕（恢復預設值）

**可調參數**:
- 顆粒強度 (`grain_intensity`: 0.0-1.0)
- 色彩飽和度 (`saturation_boost`: 0.8-1.5)
- Gamma 曲線 (`gamma`: 1.5-2.5)
- 光暈強度 (`halation`: 0.0-0.5)
- 漫射光 (`diffuse_light`: 0.0-0.3)

**UI 設計**:
```
🎛️ 高級參數調整
├─ 顆粒強度: ━━━●━━━━━━ 0.15
├─ 飽和度:   ━━━━━●━━━━ 1.10
├─ Gamma:    ━━━━━●━━━━ 1.95
├─ 光暈強度: ━━●━━━━━━━ 0.08
└─ 漫射光:   ━●━━━━━━━━ 0.05

[重置為預設值] [應用變更]
```

**驗收標準**:
- 參數調整響應時間 <1 秒
- 預覽圖實時更新
- 不影響批量處理功能

---

### 5. 自定義胶片參數系統 📝 (Low Priority)

**目標**: 支援用戶保存和分享自定義胶片

**功能需求**:
- [ ] YAML/JSON 格式導出（`film_profile.to_yaml()`）
- [ ] 自定義胶片導入（`FilmProfile.from_yaml()`）
- [ ] 胶片庫管理（保存多個自定義配置）
- [ ] 參數驗證（確保導入數據有效）

**YAML 格式範例**:
```yaml
name: "MyCustomFilm"
type: "color"
film_base:
  gamma: 2.0
  saturation_boost: 1.15
emulsion_layers:
  red:
    peak_sensitivity: 620
    grain_intensity: 0.12
    diffuse_light: 0.05
  green:
    peak_sensitivity: 540
    grain_intensity: 0.10
    diffuse_light: 0.03
  blue:
    peak_sensitivity: 450
    grain_intensity: 0.08
    diffuse_light: 0.02
halation: 0.1
antihalation_dye_retention: 0.02
```

**驗收標準**:
- 支援導入/導出 YAML 和 JSON
- 參數驗證（防止無效數據）
- 自定義胶片可在批量處理中使用

---

## 🧪 測試計劃

### 單元測試
- [ ] `test_batch_processing.py` - 批量處理引擎測試
- [ ] `test_zip_export.py` - ZIP 生成測試
- [ ] `test_custom_profiles.py` - 自定義胶片導入/導出測試

### 集成測試
- [ ] 批量處理 + 進度條整合測試
- [ ] 批量處理 + ZIP 下載整合測試
- [ ] 高級參數 + 實時預覽整合測試

### 性能測試
- [ ] 批量處理 10/50/100 張照片性能測試
- [ ] 記憶體占用測試（防止 OOM）
- [ ] ZIP 壓縮性能測試

---

## 📐 技術架構

### 新模塊結構
```
Phos/
├── Phos_0.2.0.py              # v0.2.0 主程序
├── phos_core.py               # 核心處理模塊（已有）
├── phos_batch.py              # 🆕 批量處理模塊
│   ├── batch_processor()
│   ├── parallel_batch_process()
│   └── create_zip_archive()
├── phos_ui.py                 # 🆕 UI 組件模塊
│   ├── render_progress_bar()
│   ├── render_advanced_params()
│   └── render_batch_upload()
├── phos_profiles.py           # 🆕 自定義胶片管理
│   ├── export_profile_yaml()
│   ├── import_profile_yaml()
│   └── validate_profile()
└── film_models.py             # 胶片數據模型（已有）
```

### 依賴更新
```txt
# 新增依賴
pyyaml>=6.0          # YAML 解析
tqdm>=4.66.0         # 進度條（如需 CLI）
```

---

## 🗓️ 開發時程（Development Timeline）

### Phase 1: 批量處理核心 (Week 1-2)
- [x] 規劃與設計
- [ ] 實現 `phos_batch.py` 模塊
- [ ] 多文件上傳 UI
- [ ] 批量處理引擎
- [ ] 單元測試

### Phase 2: 進度條與 ZIP 下載 (Week 2-3)
- [ ] 實現進度條顯示
- [ ] 實現 ZIP 壓縮與下載
- [ ] 整合測試

### Phase 3: 高級功能 (Week 3-4)
- [ ] 高級參數調整 UI
- [ ] 自定義胶片系統
- [ ] 功能測試

### Phase 4: 優化與文檔 (Week 4)
- [ ] 性能優化
- [ ] 文檔更新
- [ ] 發布準備

---

## 🎯 成功指標

### 功能完整度
- [ ] 支援批量處理 2-50 張照片
- [ ] 進度條準確顯示處理進度
- [ ] ZIP 下載功能穩定可靠
- [ ] 高級參數調整可用
- [ ] 自定義胶片導入/導出可用

### 性能指標
- 批量處理速度: 比逐張快 50%+
- 記憶體占用: <2GB (10 張照片)
- ZIP 生成時間: <10 秒 (10 張照片)

### 質量指標
- 測試覆蓋率: >80%
- 無已知嚴重 bug
- 文檔完整更新

---

## 🚧 已知風險與挑戰

### 技術風險
1. **記憶體管理**: 批量處理可能導致 OOM
   - **緩解方案**: 使用生成器、流式處理、限制並行數量

2. **Streamlit 限制**: Streamlit 的狀態管理較複雜
   - **緩解方案**: 使用 `st.session_state` 仔細管理狀態

3. **跨平台兼容性**: ZIP 壓縮在不同系統可能有問題
   - **緩解方案**: 使用標準 `zipfile` 模塊，充分測試

### UX 風險
1. **處理時間過長**: 50 張照片可能需要數分鐘
   - **緩解方案**: 清晰的進度提示、支援取消操作

2. **參數調整複雜**: 新手可能不理解參數含義
   - **緩解方案**: 提供預設值、tooltips 說明、視覺化預覽

---

## 📝 開發原則

1. **向後兼容**: v0.2.0 必須兼容 v0.1.3 的所有功能
2. **漸進式交付**: 優先完成核心功能（批量處理），再添加進階功能
3. **測試驅動**: 每個新功能必須有對應測試
4. **性能優先**: 批量處理必須比逐張快，否則沒有意義
5. **用戶體驗**: 進度反饋、錯誤提示、操作簡潔

---

## 📋 待決問題（Open Questions）

1. **批量處理並行度**: 使用 `ThreadPoolExecutor` 還是 `ProcessPoolExecutor`？
   - 初步決定: `ProcessPoolExecutor`（繞過 GIL，CPU 密集型任務）

2. **自定義胶片格式**: YAML vs JSON vs TOML？
   - 初步決定: 同時支援 YAML 和 JSON（YAML 更易讀，JSON 更通用）

3. **高級參數 UI 放置位置**: Sidebar vs Expander vs Modal？
   - 初步決定: Expander（不佔主要空間，需要時展開）

4. **ZIP 檔名規則**: 是否包含時間戳？
   - 初步決定: 包含（避免覆蓋，格式: `Phos_Batch_FilmName_YYYYMMDD_HHMMSS.zip`）

---

## 🎉 v0.2.0 願景

**讓 Phos 成為攝影師的批量胶片模擬工具。**

v0.2.0 將使 Phos 從「單張照片處理工具」升級為「專業攝影工作流工具」，支援大量照片的高效處理，同時保留 v0.1.3 的高質量胶片模擬效果。

---

**Roadmap Created**: 2025-12-19  
**Next Update**: 待 Phase 1 完成後更新
