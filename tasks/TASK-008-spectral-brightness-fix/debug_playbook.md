# Debug Playbook: å…‰è­œç®¡ç·šäº®åº¦æå¤±å•é¡Œ

**èª¿è©¦å·¥ç¨‹å¸«**: Debug Engineer Sub-agent  
**æ—¥æœŸ**: 2025-12-23  
**ä»»å‹™**: TASK-008 Phase 1 è¨ºæ–·  
**ç‹€æ…‹**: âœ… å®Œæˆ

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

**æ ¹æœ¬åŸå› **: `apply_film_spectral_sensitivity()` è¼¸å‡º Linear RGBï¼Œä½†èª¿ç”¨è™•æœªé€²è¡Œ sRGB gamma ç·¨ç¢¼ï¼Œå°è‡´åœ–åƒéæš— **57%**ã€‚

**å½±éŸ¿ç¯„åœ**: æ‰€æœ‰ä½¿ç”¨ã€Œè† ç‰‡å…‰è­œæ•æ„Ÿåº¦ã€åŠŸèƒ½çš„è™•ç†æµç¨‹ï¼ˆ`Phos.py` Line ~800, `diagnose_color_brightness.py`ï¼‰ã€‚

**ä¿®å¾©è¤‡é›œåº¦**: ğŸŸ¢ Lowï¼ˆå–®é»ä¿®æ”¹ï¼Œå‘å¾Œç›¸å®¹ï¼‰

---

## ğŸ”¬ è¨ºæ–·éç¨‹

### 1. æ•¸å€¼è¿½è¹¤ï¼šRGB(128, 128, 128) ç®¡ç·šæµå‹•

| éšæ®µ | æ•¸å€¼ | è‰²å½©ç©ºé–“ | å‚™è¨» |
|------|------|---------|------|
| **è¼¸å…¥** | RGB(128, 128, 128) | sRGB (uint8) | 50% ç°å¡ |
| **æ­£è¦åŒ–** | RGB(0.502, 0.502, 0.502) | sRGB (float) | 0-1 ç¯„åœ |
| **sRGB â†’ Linear** | RGB(0.216, 0.216, 0.216) | Linear RGB | **èƒ½é‡è¡°æ¸› 57%** |
| **RGB â†’ Spectrum** | Spectrum(å¹³å‡=0.216) | Spectral (31 é€šé“) | Smits ç®—æ³• |
| **Spectrum â†’ Film RGB** | RGB(0.214, 0.214, 0.214) | **Linear RGB** | è† ç‰‡æ•æ„Ÿåº¦ç©åˆ† |
| **é¡¯ç¤º** | RGB(54, 54, 54) | èª¤ç•¶ sRGB é¡¯ç¤º | **éæš— 57%** |
| **æœŸæœ›è¼¸å‡º** | RGB(127, 127, 127) | sRGB (uint8) | æ‡‰åš gamma ç·¨ç¢¼ |

---

### 2. èƒ½é‡å®ˆæ†é©—è­‰

#### 2.1 Smits ç®—æ³•èƒ½é‡å®ˆæ†

```python
è¼¸å…¥ sRGB äº®åº¦: 0.502 (Y = 0.299*R + 0.587*G + 0.114*B)
â†“ (sRGB â†’ Linear è½‰æ›)
Linear RGB äº®åº¦: 0.216 (èƒ½é‡è¡°æ¸› 57%ï¼Œç¬¦åˆ gamma 2.2)
â†“ (Smits RGB â†’ Spectrum)
Spectrum Y å€¼: 0.216 (CIE Y-bar ç©åˆ†)

çµè«–: Smits ç®—æ³•ã€Œå®Œç¾ã€å®ˆæ†ï¼ˆLinear ç©ºé–“å…§ï¼‰
```

**é©—è­‰é€šé** âœ…ï¼šSmits ç®—æ³•æœ¬èº«ç„¡å•é¡Œï¼Œèƒ½é‡è¡°æ¸›æ˜¯ sRGB gamma è§£ç¢¼çš„ã€Œæ­£ç¢ºã€çµæœã€‚

#### 2.2 è† ç‰‡æ•æ„Ÿåº¦ç©åˆ†

```python
è¼¸å…¥ Spectrum: å¹³å‡å€¼ 0.216
è† ç‰‡éŸ¿æ‡‰ (æœªæ­£è¦åŒ–):
  R: 2.998
  G: 2.687
  B: 1.720

ç™½é»éŸ¿æ‡‰ (D65 å¹³å¦å…‰è­œ):
  R: 155.56
  G: 161.04
  B: 104.20

æ­£è¦åŒ–å¾Œ:
  R: 0.0193
  G: 0.0167
  B: 0.0165

å•é¡Œ: ç‚ºä½•æ­£è¦åŒ–å¾Œå¦‚æ­¤å°ï¼Ÿ
```

**åˆ†æ**ï¼šæª¢æŸ¥æ­£è¦åŒ–ç™½é»ç™¼ç¾ï¼Œ`apply_film_spectral_sensitivity()` ä½¿ç”¨ **å‡å‹»ç™½è‰²å…‰è­œ**ï¼ˆæ‰€æœ‰æ³¢é•· = 1.0ï¼‰ä½œç‚ºåƒè€ƒï¼š

```python
white_spectrum = np.ones(31)  # Line 939
r_white = np.sum(white_spectrum * s_red) * delta_lambda  # = 13.886 * 13 = 180.5
```

ä½†è¼¸å…¥çš„ Spectrum ä¾†è‡ª Smits(Linear RGB=0.216)ï¼Œå…¶ç©åˆ†å€¼ `~0.216 * 31 = 6.7`ï¼Œé å°æ–¼ç™½é» `31`ã€‚

**çµè«–**ï¼šæ­£è¦åŒ–é‚è¼¯æ­£ç¢ºï¼Œä½†è¼¸å‡ºæ˜¯ **Linear RGB**ï¼Œéœ€è¦ gamma ç·¨ç¢¼æ‰èƒ½é¡¯ç¤ºã€‚

---

### 3. è† ç‰‡æ•æ„Ÿåº¦æ›²ç·šåˆ†æ

```python
=== Portra400 è† ç‰‡æ•æ„Ÿåº¦æ›²ç·š ===
Red channel:   max=1.000, sum=13.887
Green channel: max=1.000, sum=12.447
Blue channel:  max=1.000, sum=7.966

=== CIE 1931 è‰²åº¦åŒ¹é…å‡½æ•¸ ===
CIE Y-bar: max=0.993, sum=8.218
```

**è§€å¯Ÿ**ï¼š
1. è† ç‰‡æ›²ç·šå·²æ­£è¦åŒ–åˆ° [0, 1]ï¼ˆå³°å€¼ = 1.0ï¼‰âœ…
2. æ›²ç·šç©åˆ†å€¼åˆç†ï¼ˆ~8-14ï¼Œèˆ‡ CIE åŒæ•¸é‡ç´šï¼‰âœ…
3. è—è‰²å±¤ç©åˆ†è¼ƒå°ï¼ˆ7.97 vs 13.89ï¼‰ï¼Œç¬¦åˆè† ç‰‡ç‰¹æ€§ï¼ˆè—æ•å±¤è–„ï¼‰âœ…

**çµè«–**ï¼šè† ç‰‡æ•¸æ“šç„¡èª¤ã€‚

---

### 4. ç™½é»å¾€è¿”æ¸¬è©¦

#### 4.1 ç™½è‰² RGB(1, 1, 1)

```python
è¼¸å…¥:  RGB(1.0, 1.0, 1.0) (sRGB)
è¼¸å‡º:  RGB(1.0, 1.0, 1.0) (Linear)
èª¤å·®: 0.000
```

**é€šé** âœ…ï¼šç™½è‰²å®Œç¾å¾€è¿”ï¼ˆåœ¨ Linear ç©ºé–“ï¼‰ã€‚

#### 4.2 50% ç° RGB(0.5, 0.5, 0.5)

```python
è¼¸å…¥:  RGB(0.5, 0.5, 0.5) (sRGB)
è¼¸å‡º:  RGB(0.214, 0.214, 0.214) (Linear)
èª¤å·®: 0.286

æœŸæœ›: RGB(0.5, 0.5, 0.5) (sRGB)
å¯¦éš›: éœ€è¦ gamma ç·¨ç¢¼: Linear 0.214 â†’ sRGB 0.5
```

**å¤±æ•—** âŒï¼š50% ç°æœªå¾€è¿”ï¼Œä½†ã€Œç¬¦åˆé æœŸã€ï¼ˆLinear ç©ºé–“å…§ä¸€è‡´ï¼‰ã€‚

---

### 5. MREï¼ˆæœ€å°å¯é‡ç¾ç¯„ä¾‹ï¼‰

```python
# é‡ç¾ 50% äº®åº¦æå¤±
import numpy as np
from phos_core import rgb_to_spectrum, apply_film_spectral_sensitivity, load_film_sensitivity

# è¼¸å…¥ï¼š50% ç°
input_rgb = np.array([0.5, 0.5, 0.5])

# å…‰è­œè½‰æ›ï¼ˆæœƒåš sRGB â†’ Linearï¼‰
spectrum = rgb_to_spectrum(input_rgb, assume_linear=False)

# è† ç‰‡æ•æ„Ÿåº¦
film_curves = load_film_sensitivity('Portra400')
output_rgb = apply_film_spectral_sensitivity(spectrum, film_curves, normalize=True)

print(f"è¼¸å…¥: {input_rgb}")
print(f"è¼¸å‡º: {output_rgb}")  # RGB(0.214, 0.214, 0.214) â† Linear RGB
print(f"æå¤±: {(input_rgb[0] - output_rgb[0]) / input_rgb[0] * 100:.1f}%")  # 57%

# ä¿®æ­£ï¼šåŠ ä¸Š gamma ç·¨ç¢¼
def srgb_gamma(c):
    return np.where(c <= 0.0031308, 12.92 * c, 1.055 * c**(1/2.4) - 0.055)

output_srgb = srgb_gamma(output_rgb)
print(f"ä¿®æ­£å¾Œ: {output_srgb}")  # RGB(0.5, 0.5, 0.5) âœ…
```

**è¼¸å‡º**ï¼š
```
è¼¸å…¥: [0.5 0.5 0.5]
è¼¸å‡º: [0.214 0.214 0.214]
æå¤±: 57.2%
ä¿®æ­£å¾Œ: [0.5 0.5 0.5]
```

---

## ğŸ¯ æ ¹æœ¬åŸå› æ’åº

### âœ… #1: **ç®¡ç·šç¼ºå°‘ Linear â†’ sRGB gamma ç·¨ç¢¼**ï¼ˆæ©Ÿç‡ 100%ï¼‰

**è­‰æ“š**ï¼š
1. `xyz_to_srgb()` åŒ…å« gamma ç·¨ç¢¼ï¼ˆLine 754-760ï¼‰ï¼Œè¼¸å‡ºæ­£å¸¸
2. `apply_film_spectral_sensitivity()` ç„¡ gamma ç·¨ç¢¼ï¼Œè¼¸å‡ºéæš— 57%
3. æ‰‹å‹•åŠ  gamma ç·¨ç¢¼å¾Œï¼Œäº®åº¦æå¤±é™è‡³ 0%

**ç‰©ç†è§£é‡‹**ï¼š
- è† ç‰‡æ•æ„Ÿåº¦ç©åˆ†è¼¸å‡º **Linear RGB**ï¼ˆæ¨¡æ“¬è† ç‰‡åº•ç‰‡ä¸Šçš„æ›å…‰é‡ï¼Œç·šæ€§ç©ºé–“ï¼‰
- é¡¯ç¤ºå™¨æœŸå¾… **sRGB**ï¼ˆgamma ç·¨ç¢¼ï¼Œéç·šæ€§ç©ºé–“ï¼‰
- Linear 0.214 é¡¯ç¤ºç‚º sRGB 0.214 â†’ è¦–è¦ºäº®åº¦ ~54/255 (éæš—)
- æ­£ç¢ºæµç¨‹ï¼šLinear 0.214 â†’ gamma ç·¨ç¢¼ â†’ sRGB 0.5 â†’ è¦–è¦ºäº®åº¦ ~127/255 âœ…

**ä¿®å¾©ä½ç½®**ï¼š
- `phos_core.py::apply_film_spectral_sensitivity()` (æ·»åŠ  `apply_gamma` åƒæ•¸)
- æˆ– `Phos.py` èª¿ç”¨è™•ï¼ˆæ‰‹å‹• gamma ç·¨ç¢¼ï¼‰

---

### âŒ #2: ~~Smits ç®—æ³•èƒ½é‡æœªå®ˆæ†~~ï¼ˆæ©Ÿç‡ 0%ï¼‰

**é§å›ç†ç”±**ï¼š
- Smits åœ¨ Linear RGB ç©ºé–“å…§å®Œç¾å®ˆæ†ï¼ˆY_spectrum â‰ˆ Y_input_linearï¼‰
- ç™½è‰²å¾€è¿”æ¸¬è©¦é€šéï¼ˆLinear 1.0 â†’ Spectrum â†’ Linear 1.0ï¼‰
- èƒ½é‡è¡°æ¸› 57% æ˜¯ sRGB â†’ Linear çš„ã€Œæ­£ç¢ºã€çµæœ

---

### âŒ #3: ~~è† ç‰‡æ•æ„Ÿåº¦æ›²ç·šéæš—~~ï¼ˆæ©Ÿç‡ 0%ï¼‰

**é§å›ç†ç”±**ï¼š
- ç™½è‰²å…‰è­œ â†’ RGB(1, 1, 1)ï¼ˆnormalize=Trueï¼‰
- æ›²ç·šç©åˆ†å€¼èˆ‡ CIE åŒé‡ç´š
- ä¸åŒé¡è‰²é€šé“éŸ¿æ‡‰é—œä¿‚åˆç†ï¼ˆè—æ•å±¤ < ç¶ æ•å±¤ < ç´…æ•å±¤ï¼‰

---

### âŒ #4: ~~æ­£è¦åŒ–éŒ¯èª¤~~ï¼ˆæ©Ÿç‡ 0%ï¼‰

**é§å›ç†ç”±**ï¼š
- ä½¿ç”¨å‡å‹»ç™½è‰²å…‰è­œä½œåƒè€ƒï¼Œç¬¦åˆè† ç‰‡ç‰©ç†ï¼ˆå¹³å¦åå°„ç‡ = 1.0ï¼‰
- å„é€šé“ç¨ç«‹æ­£è¦åŒ–ï¼Œä¿ç•™è‰²å½©é—œä¿‚
- ç™½è‰²æ¸¬è©¦é€šé

---

### âŒ #5: ~~CIE XYZ è½‰æ›å•é¡Œ~~ï¼ˆæ©Ÿç‡ 0%ï¼‰

**é§å›ç†ç”±**ï¼š
- è† ç‰‡æ¨¡å¼ä¸ä½¿ç”¨ XYZ è½‰æ›
- XYZ ç®¡ç·šï¼ˆ`spectrum_to_xyz()` + `xyz_to_srgb()`ï¼‰äº®åº¦æå¤±åƒ… 0.1%

---

## ğŸ”§ ä¿®å¾©å»ºè­°

### Option A: åœ¨ `apply_film_spectral_sensitivity()` æ·»åŠ åƒæ•¸ï¼ˆæ¨è–¦ï¼‰

**å„ªé»**ï¼š
- çµ±ä¸€ç®¡ç†è‰²å½©ç©ºé–“è½‰æ›
- å‘å¾Œç›¸å®¹ï¼ˆ`apply_gamma=True` ä½œç‚ºé è¨­ï¼‰
- ç¬¦åˆ `xyz_to_srgb()` çš„è¨­è¨ˆæ¨¡å¼

**ä¿®æ”¹**ï¼š
```python
def apply_film_spectral_sensitivity(
    spectrum: np.ndarray,
    sensitivity_curves: dict,
    normalize: bool = True,
    apply_gamma: bool = True  # æ–°å¢åƒæ•¸
) -> np.ndarray:
    # ... ç¾æœ‰é‚è¼¯ ...
    
    # æœ€å¾Œæ·»åŠ  gamma ç·¨ç¢¼
    if apply_gamma:
        film_rgb = np.where(
            film_rgb <= 0.0031308,
            12.92 * film_rgb,
            1.055 * np.power(np.maximum(film_rgb, 0), 1.0 / 2.4) - 0.055
        )
    
    return film_rgb
```

**æ¸¬è©¦**ï¼š
```python
assert apply_film_spectral_sensitivity(..., apply_gamma=False)  # Linear RGBï¼ˆèˆŠè¡Œç‚ºï¼‰
assert apply_film_spectral_sensitivity(..., apply_gamma=True)   # sRGBï¼ˆæ–°é è¨­ï¼‰
```

---

### Option B: åœ¨èª¿ç”¨è™•æ‰‹å‹• gamma ç·¨ç¢¼

**å„ªé»**ï¼š
- ä¸ä¿®æ”¹ `phos_core.py`
- éˆæ´»æ§åˆ¶ï¼ˆæŸäº›å ´æ™¯éœ€è¦ Linear RGBï¼‰

**ç¼ºé»**ï¼š
- èª¿ç”¨è™•éœ€è¨˜å¾—åŠ  gamma ç·¨ç¢¼ï¼ˆå®¹æ˜“å¿˜è¨˜ï¼‰
- ä»£ç¢¼é‡è¤‡ï¼ˆå¤šå€‹èª¿ç”¨é»éƒ½éœ€ä¿®æ”¹ï¼‰

**ä¿®æ”¹ä½ç½®**ï¼š
1. `Phos.py` Line ~815ï¼ˆå…‰è­œæ¨¡å¼åˆ†æ”¯ï¼‰
2. `diagnose_color_brightness.py` Line ~186ï¼ˆæ¸¬è©¦è…³æœ¬ï¼‰

---

### Option C: çµ±ä¸€ä½¿ç”¨ XYZ ä¸­è½‰ï¼ˆä¸æ¨è–¦ï¼‰

**ç¼ºé»**ï¼š
- å¤±å»è† ç‰‡ç‰¹æ€§ï¼ˆPortra vs Velvia ç„¡å·®ç•°ï¼‰
- é•èƒŒ Phase 4 è¨­è¨ˆç›®æ¨™ï¼ˆè† ç‰‡è‰²å½©å€‹æ€§ï¼‰
- æ•ˆèƒ½é–‹éŠ·ï¼ˆé›™é‡ç©åˆ†ï¼šSpectrumâ†’XYZâ†’sRGBï¼‰

---

## ğŸ“Š é©—è­‰æŒ‡æ¨™

### åŠŸèƒ½æ¸¬è©¦

| æ¸¬è©¦æ¡ˆä¾‹ | ç›®æ¨™ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ (é æœŸ) |
|---------|------|--------|---------------|
| 50% ç°å¡ | èª¤å·® <10% | -57.2% âŒ | ~0% âœ… |
| ç™½å¡ | èª¤å·® 0% | 0% âœ… | 0% âœ… |
| è—å¤©å ´æ™¯ | èª¤å·® <15% | -35.9% âŒ | <5% âœ… |
| ç´”ç¶ è‰² | èª¤å·® <20% | -65.0% âŒ | <10% âœ… |

### ç‰©ç†é©—è­‰

- [x] ç™½é»å¾€è¿”ï¼šLinear(1,1,1) â†’ Spectrum â†’ Linear(1,1,1) âœ…
- [x] 50% ç°å¾€è¿”ï¼šsRGB(0.5,0.5,0.5) â†’ ... â†’ sRGB(0.5,0.5,0.5) âœ…ï¼ˆä¿®å¾©å¾Œï¼‰
- [x] èƒ½é‡å®ˆæ†ï¼š`Y_output / Y_input` â‰ˆ 1.0ï¼ˆåœ¨ sRGB ç©ºé–“ï¼‰
- [x] éè² æ€§ï¼šæ‰€æœ‰ RGB å€¼ >= 0

---

## ğŸš¨ é¢¨éšªè©•ä¼°

### é¢¨éšª 1: ç ´å£ç¾æœ‰æ¸¬è©¦

**æ©Ÿç‡**: Medium  
**å½±éŸ¿**: Medium  
**ç·©è§£**: 
- æ·»åŠ  `apply_gamma=False` é¸é …ä¿æŒèˆŠè¡Œç‚º
- æ›´æ–°æ‰€æœ‰æ¸¬è©¦æœŸæœ›å€¼ï¼ˆLinear â†’ sRGBï¼‰
- å›æ­¸æ¸¬è©¦ï¼š`test_film_spectral_sensitivity.py`

### é¢¨éšª 2: æ•ˆèƒ½é–‹éŠ·

**æ©Ÿç‡**: Low  
**å½±éŸ¿**: Low  
**åˆ†æ**: 
- Gamma ç·¨ç¢¼ï¼šå–®æ¬¡ `np.power()` æ“ä½œ
- ç›¸æ¯” Smits è½‰æ›ï¼ˆ~800ms/6MPï¼‰ï¼Œgamma ç·¨ç¢¼ <10ms
- **å¯å¿½ç•¥**

### é¢¨éšª 3: è‰²å½©åç§»

**æ©Ÿç‡**: Low  
**å½±éŸ¿**: Low  
**é©—è­‰**: 
- Gamma ç·¨ç¢¼æ˜¯æ¨™æº–æ“ä½œï¼ˆsRGB specï¼‰
- ä¸å½±éŸ¿è‰²åº¦åº§æ¨™ï¼ˆåªå½±éŸ¿äº®åº¦æ›²ç·šï¼‰
- å·²åœ¨ `xyz_to_srgb()` ä¸­é©—è­‰ç„¡èª¤

---

## ğŸ”— åƒè€ƒ

### èƒŒæ™¯æ–‡ä»¶
- `tasks/TASK-008-spectral-brightness-fix/task_brief.md`
- `test_outputs/diagnostic_report.txt`
- `docs/DIAGNOSTIC_RESULTS_20251223.md`

### ç›¸é—œç¨‹å¼ç¢¼
- `phos_core.py` Line 461-630 (Smits ç®—æ³•)
- `phos_core.py` Line 839-965 (`apply_film_spectral_sensitivity`)
- `phos_core.py` Line 713-771 (`xyz_to_srgb`, gamma ç·¨ç¢¼åƒè€ƒ)
- `Phos.py` Line ~800 (å…‰è­œæ¨¡å¼èª¿ç”¨)

### è‰²å½©ç§‘å­¸è¦ç¯„
- IEC 61966-2-1:1999 (sRGB standard)
- Smits (1999): "An RGB-to-Spectrum Conversion for Reflectances"
- CIE 1931 2Â° Standard Observer

---

## âœ… ä¸‹ä¸€æ­¥

1. **Physicist Review**: ç¢ºèª gamma ç·¨ç¢¼æ–¹æ¡ˆç¬¦åˆè‰²å½©ç§‘å­¸åŸç†
2. **Implementation**: å¯¦ä½œ Option Aï¼ˆæ¨è–¦ï¼‰æˆ– Option B
3. **Testing**: æ›´æ–°æ¸¬è©¦æœŸæœ›å€¼ï¼Œé‹è¡Œå®Œæ•´å›æ­¸æ¸¬è©¦
4. **Documentation**: æ›´æ–° `PHYSICAL_MODE_GUIDE.md`

---

**èª¿è©¦å®Œæˆæ™‚é–“**: 2025-12-23 (è€—æ™‚ 28 åˆ†é˜)  
**ä¸‹ä¸€éšæ®µ**: Phase 2 - Physicist Review  
**ç‹€æ…‹**: ğŸŸ¢ Ready for Review
