# 物理審查報告的審查報告

## 執行摘要
- 總體評價：部分正確
- 主要問題：
  - 報告對單位與量綱的問題、能量守恆與 H&D 曲線的建議多數合理，但部分散射理論（Mie/Rayleigh/Thomson）公式與依據錯誤或混淆。
  - 測試建議中的參數範圍與「gamma=2.2」存在概念混用（顯示 gamma vs 膠片 gamma），且「吸收係數在 0-1」的斷言不嚴謹。
  - 曝光公式雖有來自光學攝影的近似形式，但未明確條件，易誤導。

## 詳細審查

### 第一部分：物理定義與公式的正確性

- Luminance 與 Radiance 定義：
  - 報告使用的形式 L_v = d^2Φ_v / (dA·dΩ·cosθ) 與 Radiance L_e 的對應關係正確，單位 cd/m² 與 W/(m²·sr)均正確。此處為正確陳述。
  - 指出程式以無量綱 sRGB 值進行計算，不是物理亮度/輻射度，屬於準確觀察。

- Beer–Lambert Law：
  - 報告給出 I = I0 e^{-α d} 形式，若 α 為吸收係數（1/m），d 為厚度，形式正確。
  - 對「吸收係數 vs 吸收率 vs 量子效率」的區分合理；指出現有參數未賦予物理意義，合理。

- Halation vs Bloom 概念：
  - 對膠片 Halation 的成因（背層反射二次曝光）描述正確、常見於高光區域，常見紅/黃暈也符合經驗。
  - 對數位感測器 Bloom（電荷溢出）沿特定方向擴散的描述合理。
  - 但報告後續將散射角分布引用到「Mie Scattering」的公式存在錯誤（見下文）。

- 散射理論（Mie/Rayleigh/Thomson）引用：
  - 報告給出的「I_scattered(θ) = I0 · (1+cos^2θ)/2 · (λ^4)/(r^4) · S(θ,λ,n)」不正確。
    - (1+cos^2θ) 的角度相依相函數是「Thomson/Rayleigh」散射的相函數近似，而非一般的 Mie 散射。Mie 散射相函數需由 Mie 理論數值計算，並非簡單閉式。（Rayleigh 的波長依賴為 λ^{-4}，報告卻寫為 λ^{4}，符號與量綱錯誤。）
    - 對粒徑 r 的依賴亦非 r^{-4} 的簡單形式；Rayleigh 散射的截面 ~ r^6（相對於波長尺度的小粒子），而強度的距離與粒徑依賴需要明確的場與幾何設定，報告式子混雜且錯誤。
  - 結論：該段「Mie Scattering」公式與解釋錯誤且混用不同機制，需更正為概念性敘述或引用正確的 Rayleigh 相函數與波長依賴，或在膠片微結構的尺度下以實證 PSF 而非理論閉式。

- Radiative Transfer Equation（RTE）：
  - 報告的簡式 dI/ds = -μ_t I + μ_s ∫ I(s′) p(s′→s) dΩ′ 為常見吸收+散射項的定性形式，雖未包含自發/外加發射項，對膠片介質的簡化描述尚可接受。
  - 隨後的簡化 I_total = I_direct e^{-τ} + I_scattered 作為直射衰減加散射累積的啟發式也合理。

- H&D 曲線（Hurter–Driffield）：
  - D = γ log10(H) + D_fog 的線性區段表述正確；膠片的 toe/shoulder 非線性建議也合理。
  - 從密度到透射率 T = 10^{-D} 的轉換正確。

- 曝光公式 H 與光圈/亮度的關係：
  - 報告給出 H = L · t · π / [4 f^2 (1+m)^2]，這是從成像光學中由亮度 L 導出影像面照度 E ≈ L · (π/4f^2)（忽略像距放大率 m 時）並乘以時間 t 得到曝光量的近似形式。該式作為近似是常見（在某些教科書中見到），但：
    - 應明確適用條件（薄透鏡、朗伯特表面、忽略鏡頭傳輸與像面幾何、m≈0），否則易誤導。
    - 單位標註為 lux·s 對 H（照度積分）正確。

### 第二部分：批評的合理性

- 光度計算缺乏物理單位：
  - 合理。以 0–1 sRGB 進行線性組合，若宣稱為 Luminance/Radiance 物理量則不成立；建議改名為「相對光譜/顏色響應」合理。

- 能量守恆未被遵守（Bloom 效果）：
  - 合理。若將效果視為物理散射/反射造成的暈影，則總能量應在某種定義下守恆（至少在線性能量管線中）。現行做法純加法增亮確實破壞守恆。作為藝術效果可以不守恆，但若標榜物理模型，應修正。

- 吸收係數物理意義不明確：
  - 合理。若名為「吸收係數 α」，應具 1/m 單位並出現在 Beer–Lambert 指數中；若僅為權重，應更名並明確為無量綱相對參數。

- 光暈效果缺乏光學理論基礎：
  - 部分合理。使用高斯模糊近似 PSF 是常見工程近似，但若宣稱物理正確，應至少以能量守恆與更貼近 Halation 機制的 PSF（含背層反射與色依賴）來支持。報告對物理機制概述正確，但其散射公式引用錯誤降低了說服力。

- Tone mapping 與光學模型混淆：
  - 合理。Tone mapping 是顯示端/感知對應，不應與膠片的曝光—顯影—密度模型混為一談。分離階段是良好工程實務。

### 第三部分：改進建議的可行性

- 能量守恆的 Bloom 實作：
  - 物理上正確方向：先抽取高光能量，再用 PSF 重新分配，並從源區減去。技術上可行（卷積、閾值、比例），能提升模型物理一致性。
  - 需注意：真實 Halation 不僅僅是局部散射，還涉及背層反射路徑與色偏；PSF建模可分步迭代。

- Poisson 噪聲模擬：
  - 物理上正確方向：光子計數服從 Poisson，並可疊加顆粒結構噪聲。技術可行。需定義「exposure_level」與量化關係，避免與 sRGB 值直接混用。

- H&D 曲線實作：
  - 物理正確：以對數曝光建密度並加 toe/shoulder。技術可行。可顯著改善對膠片非線性的刻畫。

- 分離物理模擬與色調映射：
  - 物理與工程均正確。將可讀性、可驗證性與可維護性提升。

- 長期改進（物理單位與波長模型、PSF）：
  - 方向正確且可漸進推進。波長域模型需 SPD 估計（從 RGB 到 SPD 的反算不唯一，需近似或假設），PSF 合成要避免不當相乘或不符合物理的卷積鏈（應明確定義各機制的疊加方式）。

### 第四部分：發現的錯誤與修正

- 錯誤 1：散射公式錯誤與混用
  - 問題：將 (1+cos^2θ)/2、λ^4、r^4 混為「Mie Scattering」的不當公式。
  - 正確說法：
    - Rayleigh 散射的相函數 ~ (1+cos^2θ)；強度與波長依賴 ~ λ^{-4}。
    - Mie 散射需用 Mie 理論（Lorenz–Mie）數值解，具有複雜的角度依賴與尺寸/折射率參數；不宜用簡單閉式代替。
    - 若目標是工程近似的暈影，建議改以經驗 PSF（量測或文獻）或以色依賴的高斯/雙指數核近似，並強制能量守恆。

- 錯誤 2：「gamma 應該接近 2.2」的測試斷言不當
  - 問題：報告於附加測試中斷言 tone_params.gamma ≈ 2.2，這是顯示伽瑪或 sRGB/Rec.709 OETF/OTF 的典型數值，與膠片 H&D γ 概念不相同。報告在附錄中也給出膠片 gamma 典型值（負片 0.6–0.7、正片 1.5–2.0），兩者矛盾。
  - 修正：將測試針對顯示管線的 gamma（若存在）與膠片 H&D γ 分開；對膠片 γ 不以單一數字硬性斷言，而以型態與範圍（含 toe/shoulder）檢查。

- 錯誤 3：「吸收係數應在 0–1」的測試斷言不嚴謹
  - 問題：若參數命名為「吸收係數 α」，其單位為 1/m，數值不應限定在 0–1；若為「吸收率/權重」，才應位於 [0,1]。
  - 修正：
    - 先統一參數語義：α（1/m）用於 Beer–Lambert；w（無量綱）用於權重。
    - 對 α 僅測試「α ≥ 0」與量級合理性；對 w 測試 0 ≤ w ≤ 1。

- 誤導 4：PSF 合成方式需澄清
  - 問題：報告提出「psf_total = convolve(psf_diffraction, psf_scattering); psf_total = convolve(psf_total, psf_reflection)」。
  - 修正建議：
    - 若各機制可視為獨立線性系統，整體 PSF 是各機制的捲積的確成立。但應明確在空間不變線性系統假設下使用，並正規化總 PSF 以守恆能量。
    - 若機制包含非線性（如濃度依賴散射）或位置變異（空間變 PSF），則需分區或迭代處理而非單一卷積。

- 誤導 5：曝光公式適用條件未聲明
  - 修正：在文檔中列出假設（薄透鏡、朗伯特、忽略鏡頭透過率/T-stop、m≈0），並提醒此為近似，用於導出相對曝光量而非絕對校準。

## 結論與建議

- 報告可信度：中等偏高。其核心批評（單位與量綱、能量守恆、參數語義、H&D 與 tone mapping 的分離）是合理且對改進重要。然而散射理論部分存在明顯錯誤（Rayleigh/Mie/Thomson混淆），測試斷言亦有概念混用（顯示 γ vs 膠片 γ），需要修正以提升學術嚴謹性。

- 建議：
  - 接受並落實「能量守恆的暈影、Poisson 噪聲、H&D 曲線、物理—顯示分離」等建議。
  - 修訂報告中錯誤的散射公式與測試斷言，明確參數語義與單位。
  - 若選擇「混合導向（路徑 C）」：保留藝術效果，同時提供物理模式；在文檔中明確標示近似與假設，避免「計算光學」的過度宣稱。
