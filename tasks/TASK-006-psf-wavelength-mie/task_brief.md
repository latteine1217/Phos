# TASK-006: P1-3 PSF æ³¢é•·ä¾è³´æ”¹é€²ï¼ˆç¶“é©—å…¬å¼ â†’ Mie æŸ¥è¡¨ï¼‰

**å‰µå»ºæ—¥æœŸ**: 2025-12-20 21:30  
**å„ªå…ˆç´š**: P1 (é‡è¦ç‰©ç†æ”¹é€²)  
**é ä¼°æ™‚é–“**: 2-3 å°æ™‚  
**ç‹€æ…‹**: In Progress

---

## ğŸ“‹ ä»»å‹™ç›®æ¨™

å°‡ Bloom æ•£å°„çš„æ³¢é•·ä¾è³´åƒæ•¸å¾ã€Œç¶“é©—å…¬å¼ã€å‡ç´šåˆ°ã€ŒMie æŸ¥è¡¨ã€ï¼Œæå‡ç‰©ç†æº–ç¢ºåº¦ã€‚

### é©—æ”¶æ¨™æº–

1. **ç‰©ç†æº–ç¢ºåº¦**ï¼š
   - âœ… ä½¿ç”¨ Mie æŸ¥è¡¨å–ä»£ç¶“é©—å…¬å¼ï¼ˆÎ»^-3.5 â†’ Mie çœŸå¯¦å€¼ï¼‰
   - âœ… Î·(450)/Î·(650) ç¬¦åˆ Mie é æ¸¬ï¼ˆ1.5-4.0 ç¯„åœï¼‰
   - âœ… Ïƒ(450)/Ïƒ(650) ç¬¦åˆ Mie é æ¸¬ï¼ˆ1.2-2.0 ç¯„åœï¼‰

2. **åŠŸèƒ½å®Œæ•´æ€§**ï¼š
   - âœ… é è¨­å•Ÿç”¨ Mie æŸ¥è¡¨ï¼ˆ`use_mie_lookup=True`ï¼‰
   - âœ… å›é€€æ©Ÿåˆ¶ä¿ç•™ï¼ˆæŸ¥è¡¨å¤±æ•— â†’ ç¶“é©—å…¬å¼ï¼‰
   - âœ… æ‰€æœ‰ `*_MediumPhysics_Mie` é…ç½®æ›´æ–°

3. **æ¸¬è©¦è¦†è“‹**ï¼š
   - âœ… æ›´æ–° `test_wavelength_bloom.py`ï¼ˆMie æ¨¡å¼é©—è­‰ï¼‰
   - âœ… å°æ¯”ç¶“é©—å…¬å¼ vs Mie æŸ¥è¡¨ï¼ˆè¦–è¦º A/B æ¸¬è©¦ï¼‰

---

## ğŸ” ç•¶å‰ç‹€æ³åˆ†æ

### ç•¶å‰å¯¦ä½œ (Phase 1 ç¶“é©—å…¬å¼)

**æª”æ¡ˆ**: `Phos_0.3.0.py` Line 1012-1042

**å…¬å¼**:
```python
# èƒ½é‡æ¬Šé‡
eta(Î») = eta_base Ã— (Î»_ref/Î»)^p  # p = 3.5 (ç¶“é©—å€¼)

# PSF å¯¬åº¦
Ïƒ(Î») = Ïƒ_base Ã— (Î»_ref/Î»)^q      # q = 0.8 (ç¶“é©—å€¼)
```

**å•é¡Œ**:
- Î»^-3.5 ä»‹æ–¼ Rayleigh (Î»^-4) èˆ‡ Mie (Î»^-1~2) ä¹‹é–“ï¼Œç¼ºä¹ç†è«–æ”¯æŒ
- ç²’å¾‘ 0.5-3Î¼m æ™‚ï¼Œå¤šæ•¸åœ¨ Mie ç¯„åœï¼ˆx=2Ï€a/Î» â‰ˆ 3-20ï¼‰
- åŠå¾‘æ¬¡æ–¹ q=0.8 æœªå¾è§’åº¦åˆ†å¸ƒæ¨å°

### å·²å¯¦ä½œä½†æœªå•Ÿç”¨ (Phase 5 Mie æŸ¥è¡¨)

**æª”æ¡ˆ**: `Phos_0.3.0.py` Line 984-1009

**æµç¨‹**:
```python
if use_mie_lookup:  # ç•¶å‰é è¨­ False
    table = load_mie_lookup_table(mie_lookup_path)
    sigma_r, kappa_r, rho_r, eta_r = lookup_mie_params(Î»=650, iso, table)
    sigma_g, kappa_g, rho_g, eta_g = lookup_mie_params(Î»=550, iso, table)
    sigma_b, kappa_b, rho_b, eta_b = lookup_mie_params(Î»=450, iso, table)
    
    # æ­¸ä¸€åŒ–èƒ½é‡ï¼ˆç¶ å…‰ç‚ºåŸºæº–ï¼‰
    eta_r = eta_r_raw / eta_g_raw * scattering_ratio
    ...
```

**ç‹€æ…‹**: âœ… ä»£ç¢¼å·²å¯¦ä½œï¼Œä½†é…ç½®ä¸­ `use_mie_lookup=False`

---

## ğŸ¯ ä¿®æ­£ç­–ç•¥

### é¸é … Aï¼šå…¨é¢å•Ÿç”¨ Mie æŸ¥è¡¨ï¼ˆæ¨è–¦ï¼‰

**ç†ç”±**:
- Mie æŸ¥è¡¨å·²é©—è­‰ï¼ˆDecision #018, v2 æŸ¥è¡¨ 200 æ ¼é»ï¼‰
- ç‰©ç†æº–ç¢ºåº¦æå‡æ˜é¡¯
- ä»£ç¢¼å·²å¯¦ä½œï¼Œåªéœ€ä¿®æ”¹é…ç½®

**å·¥ä½œé …**:
1. æ›´æ–° `film_models.py` ä¸­æ‰€æœ‰ `WavelengthBloomParams` é…ç½®
2. è¨­ç½® `use_mie_lookup=True`
3. æŒ‡å‘ v2 æŸ¥è¡¨ï¼ˆ`mie_lookup_table_v2.npz`ï¼‰
4. æ›´æ–°æ¸¬è©¦æœŸæœ›å€¼

**é ä¼°æ™‚é–“**: 1.5-2 hours

---

### é¸é … Bï¼šä¿ç•™é›™æ¨¡å¼åˆ‡æ›

**ç†ç”±**:
- ç”¨æˆ¶å¯é¸æ“‡ã€Œç¶“é©—å…¬å¼ï¼ˆå¿«é€Ÿï¼‰ã€vsã€ŒMie æŸ¥è¡¨ï¼ˆæº–ç¢ºï¼‰ã€
- æ¸¬è©¦å°æ¯”æ•ˆæœ

**å·¥ä½œé …**:
- åŒé¸é … Aï¼Œä½†ä¿ç•™å…©ç¨®é…ç½®
- æ·»åŠ  UI åˆ‡æ›é–‹é—œï¼ˆå¯é¸ï¼‰

**é ä¼°æ™‚é–“**: 2-3 hours

---

## ğŸ“Š ç•¶å‰é…ç½®ç‹€æ³

### éœ€è¦æ›´æ–°çš„é…ç½® (4 å€‹)

æª¢æŸ¥ `film_models.py` ä¸­çš„é…ç½®ï¼š

```python
# Line 443: Portra400_MediumPhysics_Mie
Portra400_MediumPhysics_Mie = FilmProfile(
    ...
    wavelength_bloom_params=WavelengthBloomParams(
        enabled=True,
        use_mie_lookup=False,  # âŒ éœ€æ”¹ç‚º True
        mie_lookup_path="data/mie_lookup_table_v2.npz",  # âœ… å·²æŒ‡å‘ v2
        iso_value=400,
        ...
    )
)

# Line 1040: Cinestill800T_MediumPhysics_Mie
# Line 1107: Velvia50_MediumPhysics_Mie
# åŒä¸Šï¼Œéœ€æ›´æ–° use_mie_lookup=False â†’ True
```

### å·²æ­£ç¢ºçš„é…ç½®

- `Portra400_MediumPhysics`ï¼ˆPhase 1 ç¶“é©—å…¬å¼ï¼Œä¿ç•™ä¸è®Šï¼‰
- `Cinestill800T_MediumPhysics`ï¼ˆåŒä¸Šï¼‰
- é»‘ç™½è† ç‰‡ï¼ˆç„¡æ³¢é•· Bloomï¼‰

---

## ğŸš€ åŸ·è¡Œè¨ˆç•«

### Phase 1: é…ç½®æ›´æ–° (30 min)

**æ­¥é©Ÿ**:
1. æ›´æ–° 3 å€‹ `*_MediumPhysics_Mie` é…ç½®
2. è¨­ç½® `use_mie_lookup=True`
3. ç¢ºèª `mie_lookup_path="data/mie_lookup_table_v2.npz"`

**æª”æ¡ˆ**:
- `film_models.py` Line 443, 1040, 1107

---

### Phase 2: æ¸¬è©¦æ›´æ–° (45 min)

**æ­¥é©Ÿ**:
1. æ›´æ–° `test_wavelength_bloom.py`
2. æ·»åŠ  Mie æ¨¡å¼æ¸¬è©¦
3. å°æ¯”ç¶“é©—å…¬å¼ vs Mie æŸ¥è¡¨

**æ–°å¢æ¸¬è©¦**:
```python
def test_mie_lookup_vs_empirical():
    """å°æ¯” Mie æŸ¥è¡¨èˆ‡ç¶“é©—å…¬å¼"""
    # ç¶“é©—å…¬å¼
    eta_b_emp = eta_base * (550/450)**3.5 â‰ˆ eta_base * 2.86
    
    # Mie æŸ¥è¡¨ (v2, ISO 400)
    eta_b_mie = lookup_mie_params(450, 400, table)['eta']
    eta_g_mie = lookup_mie_params(550, 400, table)['eta']
    ratio_mie = eta_b_mie / eta_g_mie
    
    # é©—è­‰ Mie æ¯”ç‡åœ¨åˆç†ç¯„åœï¼ˆ1.5-4.0ï¼‰
    assert 1.5 <= ratio_mie <= 4.0
```

---

### Phase 3: è¦–è¦ºé©—è­‰ (30 min)

**æ¸¬è©¦å ´æ™¯**:
1. ç™½è‰²é«˜å…‰ï¼ˆè·¯ç‡ˆï¼‰
2. è—å¤©é«˜å°æ¯”
3. å¤œæ™¯éœ“è™¹ç‡ˆ

**å°æ¯”**:
- `Portra400_MediumPhysics` (ç¶“é©—å…¬å¼) vs
- `Portra400_MediumPhysics_Mie` (Mie æŸ¥è¡¨)

**é æœŸå·®ç•°**:
- Mie æ¨¡å¼è—è‰²å…‰æšˆå¯èƒ½ç•¥å°ï¼ˆå¦‚æœ Mie æ¯”ç‡ < 2.86ï¼‰
- æˆ–ç•¥å¤§ï¼ˆå¦‚æœ Mie æ¯”ç‡ > 2.86ï¼‰
- PSF å½¢ç‹€æ›´çœŸå¯¦ï¼ˆé›™æ®µæ ¸åƒæ•¸ä¾†è‡ª Mie è¨ˆç®—ï¼‰

---

### Phase 4: æ–‡æª”æ›´æ–° (15 min)

1. æ›´æ–° `context/decisions_log.md`ï¼ˆDecision #022ï¼‰
2. æ›´æ–° `PHYSICS_IMPROVEMENTS_ROADMAP.md`ï¼ˆP1-3 æ¨™è¨˜å®Œæˆï¼‰
3. æ›´æ–° `COMPUTATIONAL_OPTICS_TECHNICAL_DOC.md`ï¼ˆMie æŸ¥è¡¨ç« ç¯€ï¼‰

---

## ğŸ”’ é¢¨éšªèˆ‡é™åˆ¶

### é¢¨éšª 1: Mie æŸ¥è¡¨æ•¸å€¼èˆ‡ç¶“é©—å…¬å¼å·®ç•°å¤§

**å½±éŸ¿**: è¦–è¦ºæ•ˆæœå¯èƒ½è®ŠåŒ–æ˜é¡¯  
**ç·©è§£**: ä¿ç•™ç¶“é©—å…¬å¼é…ç½®ï¼ˆ`*_MediumPhysics`ï¼‰ï¼Œç”¨æˆ¶å¯é¸æ“‡

### é¢¨éšª 2: æŸ¥è¡¨æ’å€¼èª¤å·®

**å½±éŸ¿**: éæ ¼é» ISO å€¼ï¼ˆå¦‚ ISO 500ï¼‰æ’å€¼èª¤å·®  
**ç·©è§£**: v2 æŸ¥è¡¨å·²æœ‰ 20 å€‹ ISO é»ï¼Œæ’å€¼èª¤å·® < 2% (Decision #018)

### é¢¨éšª 3: æ€§èƒ½é–‹éŠ·

**å½±éŸ¿**: æŸ¥è¡¨è¼‰å…¥èˆ‡æ’å€¼æ™‚é–“  
**ç·©è§£**: å…¨åŸŸå¿«å–æ©Ÿåˆ¶ï¼ˆLine 1064ï¼‰ï¼Œé¦–æ¬¡è¼‰å…¥å¾Œ <1ms

---

## ğŸ“š åƒè€ƒè³‡æ–™

1. **Mie æŸ¥è¡¨ç”Ÿæˆ**: Decision #018 (Phase 5.5)
2. **Physicist Review**: `tasks/TASK-003-medium-physics/physicist_review.md` Line 128-160
3. **ç•¶å‰å¯¦ä½œ**: `Phos_0.3.0.py` Line 953-1058
4. **æŸ¥è¡¨æ–‡ä»¶**: `data/mie_lookup_table_v2.npz` (10 Î» Ã— 20 ISO)

---

## âœ… å®Œæˆæ¨™æº–

1. **ä»£ç¢¼**:
   - âœ… 3 å€‹ `*_MediumPhysics_Mie` é…ç½®æ›´æ–°
   - âœ… `use_mie_lookup=True` è¨­ç½®

2. **æ¸¬è©¦**:
   - âœ… `test_wavelength_bloom.py` æ›´æ–°ä¸¦é€šé
   - âœ… æ–°å¢ Mie vs ç¶“é©—å…¬å¼å°æ¯”æ¸¬è©¦

3. **æ–‡æª”**:
   - âœ… Decision #022 è¨˜éŒ„
   - âœ… Roadmap P1-3 æ¨™è¨˜å®Œæˆ

4. **é©—è­‰**:
   - âœ… è¦–è¦ºæ¸¬è©¦é€šéï¼ˆ3 å€‹å ´æ™¯ï¼‰
   - âœ… Î· æ¯”ç‡åœ¨ 1.5-4.0 ç¯„åœ
   - âœ… Ïƒ æ¯”ç‡åœ¨ 1.2-2.0 ç¯„åœ

---

**å‰µå»ºè€…**: Main Agent  
**æœ€å¾Œæ›´æ–°**: 2025-12-20 21:30
